#This is to disconnect from the database
source("/home/nathan/Dropbox/901_functions/disconnect_galaxy.R")
#Clean up fantasy_production
fantasy_production <- fantasy_production %>%
mutate(across(where(bit64::is.integer64), ~ as.integer(.))) %>%
mutate(across(where(is.integer), ~ dplyr::coalesce(., 0L)))
#Get players
sql_statement <- paste(
"
SELECT pff.pff_player_identifier as player_id, p.player_first_name || ' ' || p.player_last_name as name
FROM a_players p
INNER JOIN a_link_players_pff pff on pff.player_id = p.player_id
",
sep = ""
)
players <- dbGetQuery(n, sql_statement)
player_participation <- inner_join(
x = player_participation,
y = players,
by = "player_id"
)
fantasy_production <- inner_join(
x = fantasy_production,
y = players,
by = "player_id"
)
#This is to set things up with photos or anything else. Absense of that, I'm just removing player_ids
player_participation$player_id <- NULL
fantasy_production$player_id <- NULL
fantasy_production <- fantasy_production %>%
relocate(name, .after = franchise) %>%
select(franchise, name, position, everything())
player_participation <- player_participation %>%
relocate(name, .after = franchise) %>%
select(franchise, name, position, everything())
ppl <- select(player_participation, franchise, name, snaps)
fantasy_production <- inner_join(
x = fantasy_production,
y = ppl,
by = c("franchise", "name")
)
rm(ppl)
max_snaps$name <- "Team Total"
max_snaps$position <- " "
max_snaps <- select(
max_snaps,
franchise,
name,
position,
snaps,
routes_run,
targets,
carries
)
max_snaps$targets <- ifelse(is.na(max_snaps$targets), 0, max_snaps$targets)
#This is to remove NAs
player_participation$routes_run <- ifelse(
is.na(player_participation$routes_run),
0,
player_participation$routes_run
)
player_participation$targets <- ifelse(
is.na(player_participation$targets),
0,
player_participation$targets
)
player_participation$carries <- ifelse(
is.na(player_participation$carries),
0,
player_participation$carries
)
#This is to start a loop to get stuff by team
teams <- select(player_participation, franchise) %>% distinct()
total <- as.numeric(nrow(teams))
count <- 1
output_dir <- "~/html_tests/"
dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)
# ---------- helpers ----------
titleize <- function(x) tools::toTitleCase(gsub("_", " ", x))
# stat groups in display order (each group's rows stay together)
stat_groups <- list(
snaps = c("snaps"), # new top row
core = c("fantasy_points"),
passing = c(
"passing_fantasy_points",
"passing_attempts",
"passing_completions",
"passing_yards",
"passing_touchdowns",
"interceptions"
),
rushing = c(
"rushing_fantasy_points",
"rushing_attempts",
"rushing_yards",
"rushing_touchdowns"
),
receiving = c(
"receiving_fantasy_points",
"targets",
"receptions",
"receiving_yards",
"receiving_touchdowns"
)
)
# Transpose player-rows → stats-as-rows (with gaps between groups) & players as columns ordered by fantasy_points desc
fp_to_wide <- function(
df_pos,
drop_passing = FALSE,
drop_rushing = FALSE,
drop_receiving = FALSE
) {
if (nrow(df_pos) == 0) return(data.frame(Stat = "No data for this view"))
nm_player <- if ("name" %in% names(df_pos)) "name" else "Name"
if ("position" %in% names(df_pos)) df_pos <- select(df_pos, -position)
# order players: most fantasy_points on the left
player_order <- df_pos %>%
arrange(desc(fantasy_points)) %>%
pull(!!sym(nm_player))
# include groups in order with conditional drops
groups_included <- list(
c(stat_groups$snaps, stat_groups$core),
if (!drop_passing) stat_groups$passing,
if (!drop_rushing) stat_groups$rushing,
if (!drop_receiving) stat_groups$receiving
)
groups_included <- Filter(Negate(is.null), groups_included)
keep <- unlist(groups_included, use.names = FALSE)
keep <- intersect(keep, names(df_pos)) # guard against missing cols
long <- df_pos %>%
select(all_of(c(nm_player, keep))) %>%
pivot_longer(cols = all_of(keep), names_to = "Stat", values_to = "Value")
# preserve group+stat order
long$Stat <- factor(long$Stat, levels = keep)
wide <- long %>%
pivot_wider(names_from = !!sym(nm_player), values_from = Value) %>%
as.data.frame()
# insert blank "gap" rows after each included group except the last
group_sizes <- vapply(groups_included, length, integer(1))
cum_end <- cumsum(group_sizes)
gaps_after <- head(cum_end, -1)
if (length(gaps_after)) {
for (k in rev(gaps_after)) {
gap <- wide[1, ]
gap[1, ] <- NA
gap$Stat <- ""
wide <- rbind(wide[1:k, ], gap, wide[(k + 1):nrow(wide), ])
}
}
# pretty row labels
wide$Stat <- ifelse(wide$Stat == "", "", titleize(as.character(wide$Stat)))
# reorder columns: Stat + players (by fantasy_points desc)
# reorder columns: Stat + players (by fantasy_points desc)
players <- intersect(player_order, names(wide))
wide <- wide[, c("Stat", players), drop = FALSE]
wide
}
# ---------- Wrapping helpers (stub-agnostic) ----------
br_before_last <- function(x) sub("(.*)\\s+(\\S+)$", "\\1<br/>\\2", x)
force_mobile_wrap <- function(gt_tbl) {
# Wrap column labels (player names) by inserting <br> before the last word
cols <- setdiff(names(gt_tbl[["_data"]]), "Stat")
if (length(cols)) {
lab_map <- setNames(
lapply(cols, function(nm) gt::html(br_before_last(nm))),
cols
)
gt_tbl <- gt_tbl %>% gt::cols_label(.list = lab_map)
}
# Wrap the "Stat" column values regardless of stub usage
if ("Stat" %in% names(gt_tbl[["_data"]])) {
gt_tbl <- gt_tbl %>%
gt::text_transform(
locations = gt::cells_body(columns = "Stat"),
fn = function(x) lapply(x, function(s) gt::html(br_before_last(s)))
)
}
gt_tbl
}
# ---------- REPLACEMENT make_gt ----------
make_gt <- function(df, title, subtitle) {
df %>%
base_table() %>%
tab_header(title = title, subtitle = subtitle) %>%
tab_options(
table.width = pct(100),
column_labels.padding = px(2),
data_row.padding = px(2),
heading.padding = px(2)
) %>%
force_mobile_wrap()
}
# format numbers: FP rows show 1 decimal; everything else integer; blanks stay blank
apply_number_formats <- function(gt_tbl) {
fp_rows <- titleize(c(
"fantasy_points",
"passing_fantasy_points",
"rushing_fantasy_points",
"receiving_fantasy_points"
))
gt_tbl %>%
fmt_number(
columns = where(is.numeric),
rows = Stat %in% fp_rows,
decimals = 1
) %>%
fmt_number(
columns = where(is.numeric),
rows = Stat != "" & !(Stat %in% fp_rows),
decimals = 0
) %>%
fmt_missing(columns = everything(), missing_text = "")
}
build_fp_gt <- function(fp_team, pos_group, title_prefix) {
if (pos_group == "QB") {
df <- fp_team %>% filter(position == "QB")
drop_passing <- FALSE
drop_rushing <- FALSE
drop_receiving <- all(replace_na(df$targets, 0) == 0)
} else if (pos_group == "RB") {
df <- fp_team %>% filter(position %in% c("HB", "FB"))
drop_passing <- all(replace_na(df$passing_attempts, 0) == 0)
drop_rushing <- FALSE
drop_receiving <- FALSE
} else if (pos_group == "WR") {
df <- fp_team %>% filter(position == "WR")
drop_passing <- all(replace_na(df$passing_attempts, 0) == 0)
drop_rushing <- all(replace_na(df$rushing_attempts, 0) == 0)
drop_receiving <- FALSE
} else {
# TE
df <- fp_team %>% filter(position == "TE")
drop_passing <- all(replace_na(df$passing_attempts, 0) == 0)
drop_rushing <- all(replace_na(df$rushing_attempts, 0) == 0)
drop_receiving <- FALSE
}
wide <- fp_to_wide(df, drop_passing, drop_rushing, drop_receiving)
make_gt(
wide,
title = title_prefix,
subtitle = paste0(pos_group, " Fantasy Production")
) %>%
apply_number_formats()
}
# ---------- main loop (PP unchanged except your existing code) ----------
repeat {
if (count == 1 + total) break
current_team <- teams[count, 1]
current_franchise_name <- franchises %>%
filter(id == current_team) %>%
pull(name) %>%
.[1]
# ----- PP (build pp_graph) -----
pp <- player_participation %>%
filter(franchise == current_team) %>%
select(-franchise) %>%
arrange(desc(position), desc(snaps), name)
current_max_snaps <- max_snaps %>%
filter(franchise == current_team) %>%
select(-franchise)
pp <- rbind(pp, current_max_snaps)
colnames(pp) <- c(
"Name",
"Position",
"Snaps",
"Routes Run",
"Targets",
"Carries"
)
pp_graph <- pp %>%
base_table() %>%
tab_footnote(
footnote = "This chart only includes data for when the players who started the game continued to play in the game for the preseason. Teams will sometimes substitute some first unit players out before others. The determination of where to cut the first unit off for the purpose of the chart may change on a game by game basis."
) %>%
tab_header(
title = current_franchise_name, # line 1
subtitle = "Snap Counts" # line 2
) %>%
tab_options(table.width = pct(100)) %>%
tab_style(
style = list(
cell_fill(color = "#0B1533"),
cell_text(weight = "bold", color = "white", size = px(10))
),
locations = cells_body(rows = nrow(pp))
)
# ----- FP for this team (now includes `snaps`) -----
fp_team <- fantasy_production %>%
filter(franchise == current_team) %>%
select(-franchise)
fp_qb_graph <- build_fp_gt(fp_team, "QB", current_franchise_name)
fp_rb_graph <- build_fp_gt(fp_team, "RB", current_franchise_name)
fp_wr_graph <- build_fp_gt(fp_team, "WR", current_franchise_name)
fp_te_graph <- build_fp_gt(fp_team, "TE", current_franchise_name)
# render 5 slides
slides_html <- list(
gt::as_raw_html(pp_graph),
gt::as_raw_html(fp_qb_graph),
gt::as_raw_html(fp_rb_graph),
gt::as_raw_html(fp_wr_graph),
gt::as_raw_html(fp_te_graph)
)
slides_block <- unlist(lapply(
slides_html,
function(h)
c(
'      <section class="slide">',
h,
'      </section>'
)
))
dot_btns <- unlist(lapply(seq_along(slides_html), function(i) {
cls <- if (i == 1) 'dot active' else 'dot'
sprintf('      <button class="%s" aria-label="Slide %d"></button>', cls, i)
}))
safe_name <- gsub("[^A-Za-z0-9]+", "_", current_franchise_name)
html_file_name <- paste0(season, "_", week, "_", safe_name, ".html") # no output_dir
carousel_id <- paste0("carousel_", safe_name)
html_lines <- c(
'<!DOCTYPE html>',
'<html lang="en">',
'<head>',
'  <meta charset="UTF-8">',
'  <meta name="viewport" content="width=device-width, initial-scale=1">',
paste0(
'  <title>',
current_franchise_name,
' — Snap Counts & Fantasy Production</title>'
),
'  <style>',
'    :root{--maxW:470px; --cols:2;}', # use a *cap*, not a fixed width
'    html,body{margin:0;padding:0;background:transparent;overflow-x:hidden;}', # prevent stray X-scroll in iframe
'    .carousel{max-width:calc(min(var(--maxW), 100vw) + 24px);margin:12px auto;padding:12px;',
'              border:1px solid #d0d7e3;border-radius:12px;background:transparent;',
'              box-shadow:0 1px 2px rgba(16,24,40,.06);} ',
'    .slides{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;',
'            -webkit-overflow-scrolling:touch;background:transparent;}',
'    .slide{flex:0 0 100%;min-width:100%;box-sizing:border-box;',
'           scroll-snap-align:start;scroll-snap-stop:always;',
'           padding:0;position:relative;background:transparent;}',
'    .gt_table{margin:auto;}',
'    .labelbar{display:flex;justify-content:center;gap:8px;margin:6px 0 10px;flex-wrap:wrap;position:relative;z-index:10;}',
'    .labelbar .tab{font:600 12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;',
'                   padding:6px 10px;border:1px solid #c4ccd9;border-radius:999px;background:#fff;',
'                   color:#1f2a44;cursor:pointer;}',
'    .labelbar .tab.active{background:#1f2a44;color:#fff;border-color:#1f2a44;}',
'    .labelbar .tab:focus-visible{outline:2px solid #1f2a44;outline-offset:2px;}',
'',
'    @media (max-width:680px){',
'      .gt_table{table-layout:fixed;width:100% !important;margin:auto;border-collapse:collapse;}',
'      .gt_table .gt_title{font-size:18px;line-height:1.15;}',
'      .gt_table .gt_subtitle{font-size:12px;line-height:1.2;}',
'',
'      /* Every column gets the same width: 100% / --cols */',
'      .gt_table thead tr th, .gt_table tbody tr td{',
'        width:calc(100% / var(--cols)) !important;',
'        max-width:calc(100% / var(--cols)) !important;',
'      }',
'',
'      /* Numbers stay single line & right-aligned; STAT cells wrap & left-align */',
'      .gt_table tbody tr td{',
'        padding:2px 3px !important;font-size:11px;line-height:1.1;',
'        white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0;',
'        font-variant-numeric:tabular-nums;text-align:right;',
'      }',
'      .gt_table tbody tr td:first-child{',
'        white-space:normal !important;overflow:visible !important;text-overflow:clip !important;',
'        word-break:break-word;overflow-wrap:anywhere;hyphens:auto;text-align:left;',
'        padding:2px 6px !important;',
'      }',
'',
'      /* Headers (player names & STAT) wrap and are centered within their column */',
'      .gt_table thead th, .gt_table .gt_col_heading, .gt_table .gt_column_spanner{',
'        padding:2px 4px !important;font-size:11px;line-height:1.1;',
'        white-space:normal !important;overflow:visible !important;min-width:0;',
'        word-break:break-word;overflow-wrap:anywhere;hyphens:auto;',
'        text-align:center !important;text-overflow:clip !important;',
'      }',
'      .gt_table thead th *, .gt_table .gt_col_heading *, .gt_table .gt_column_spanner *{',
'        white-space:normal !important;overflow:visible !important;',
'        word-break:break-word;overflow-wrap:anywhere;hyphens:auto;',
'        text-align:center !important;display:block;',
'      }',
'',
'      .gt_table .gt_footnotes, .gt_table .gt_sourcenotes{font-size:10px;}',
'    }',
'',
'    @media (max-width:420px){',
'      .gt_table thead th, .gt_table .gt_col_heading, .gt_table .gt_column_spanner,',
'      .gt_table .gt_stub, .gt_table td{padding:1px 2px !important;font-size:10px !important;}',
'      .gt_table .gt_title{font-size:16px;}',
'      .gt_table .gt_subtitle{font-size:11px;}',
'      .labelbar .tab{padding:5px 8px;font-size:11px;}',
'    }',
'  </style>',
'</head>',
'<body>',
paste0('  <div class="carousel" id="', carousel_id, '">'),
'    <div class="slides">',
slides_block,
'    </div>',
'    <div class="labelbar" role="tablist" aria-label="Views">',
'      <button type="button" class="tab active" aria-label="Snaps">Snaps</button>',
'      <button type="button" class="tab" aria-label="QB">QB</button>',
'      <button type="button" class="tab" aria-label="RB">RB</button>',
'      <button type="button" class="tab" aria-label="WR">WR</button>',
'      <button type="button" class="tab" aria-label="TE">TE</button>',
'    </div>',
'    <script>',
'(function(){',
paste0('  const root=document.getElementById("', carousel_id, '");'),
'  const track  = root.querySelector(".slides");',
'  const slides = [...track.querySelectorAll(":scope > .slide")];',
'  const tabs   = [...root.querySelectorAll(".labelbar .tab")];',
'  let index = 0;',
'  const clamp = i => Math.max(0, Math.min(i, slides.length-1));',
'  function reflect(){ tabs.forEach((t,j)=>t.classList.toggle("active", j===index)); }',
'  function leftOf(i){',
'    const r = slides[i].getBoundingClientRect();',
'    const t = track.getBoundingClientRect();',
'    return (r.left - t.left) + track.scrollLeft;',
'  }',
'  function go(i){ index = clamp(i); track.scrollTo({left:leftOf(index), behavior:"smooth"}); reflect(); }',
'  tabs.forEach((t,i)=>t.addEventListener("click",(e)=>{ e.preventDefault(); e.stopPropagation(); go(i); }));',
'',
'  // -------- Make every column equal width: set --cols per table --------',
'  function sizeColumns(tbl){',
'    // Prefer the last header row; fall back to first body row',
'    let total = tbl.querySelectorAll("thead tr:last-child th").length;',
'    if (!total){ total = tbl.querySelectorAll("tbody tr:first-child td").length; }',
'    if (total){ tbl.style.setProperty("--cols", String(total)); }',
'  }',
'  function sizeAll(){ root.querySelectorAll(".gt_table").forEach(sizeColumns); }',
'  sizeAll();',
'',
'  // Keep active tab in sync while swiping',
'  let ticking = false;',
'  track.addEventListener("scroll",()=>{',
'    if (!ticking){',
'      requestAnimationFrame(()=>{',
'        const x = track.scrollLeft;',
'        let best = 0, dist = Infinity;',
'        for (let i=0;i<slides.length;i++){',
'          const d = Math.abs(x - leftOf(i));',
'          if (d < dist){ dist = d; best = i; }',
'        }',
'        if (best !== index){ index = best; reflect(); }',
'        ticking = false;',
'      });',
'      ticking = true;',
'    }',
'  });',
'  // Recompute on resize/orientation change',
'  if ("ResizeObserver" in window){',
'    new ResizeObserver(()=>{ sizeAll(); track.scrollTo({left:leftOf(index)}); }).observe(root);',
'  }',
'})();',
'    </script>',
'  </div>',
'</body>',
'</html>'
)
writeLines(html_lines, html_file_name)
count <- count + 1
}
gert::git_add(".") # stage everything
gert::git_commit("Update HTML") # commit staged files
gert::git_push(remote = "origin")
rm(
current_max_snaps,
fantasy_production,
fp_qb_graph,
fp_rb_graph,
fp_te_graph,
fp_team,
fp_wr_graph,
franchises,
max_snaps,
player_participation,
players,
pp,
pp_graph,
slides_html,
stat_groups,
teams,
carousel_id,
count,
current_franchise_name,
current_team,
dot_btns,
graph_subtitle,
halftime,
html_file_name,
html_lines,
output_dir,
safe_name,
season,
slides_block,
sql_statement,
text,
total,
week,
apply_number_formats,
base_table,
build_fp_gt,
fp_to_wide,
make_gt,
titleize,
br_before_last,
force_mobile_wrap
)
source("/home/nathan/Dropbox/901_functions/Custom footer.R")
